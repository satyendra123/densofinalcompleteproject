#include <SoftwareSerial.h>
#include <Wiegand.h>

#define RS485_RX       4
#define RS485_TX       5
#define RS485_CONTROL  6
#define RFID_D0 2
#define RFID_D1 3

SoftwareSerial rs485(RS485_RX, RS485_TX);
WIEGAND wg;

void setup() {
  Serial.begin(9600);
  rs485.begin(9600);
  wg.begin(RFID_D0, RFID_D1);

  pinMode(RS485_CONTROL, OUTPUT);
  digitalWrite(RS485_CONTROL, LOW);
  Serial.println("RS485 RFID system ready");
}

void preTransmission() {
  digitalWrite(RS485_CONTROL, HIGH);
  delayMicroseconds(10);  // Allow time to settle
}

void postTransmission() {
  delay(10);  // Wait for data to be sent
  digitalWrite(RS485_CONTROL, LOW);
}

void sendViaRS485(String data) {
  preTransmission();
  rs485.println(data);
  postTransmission();
}


void loop() {
  if (rs485.available()) {
    String received = rs485.readStringUntil('\n');
    Serial.print("Received over RS485: ");
    Serial.println(received);
  }

  if (wg.available()) {
    String rfid = String(wg.getCode());
    Serial.print("RFID Read: ");
    Serial.println(rfid);
    sendViaRS485(rfid);
  }
}



